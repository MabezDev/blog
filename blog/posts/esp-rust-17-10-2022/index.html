<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Scott Mabin" />
  <meta itemprop="description" content="Scott Mabin&#x27;s blog" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://mabez.dev/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://mabez.dev/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://mabez.dev/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://mabez.dev/favicon.ico"
  />
  <link rel="stylesheet" href="https://mabez.dev/style.css"/>
  
  <title>Rust on Espressif chips - 17-10-2022</title>
  

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://mabez.dev/rss.xml">
  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;mabez.dev">Scott Mabin</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://mabez.dev/blog/posts">Blog</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;scott-mabin" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="https:&#x2F;&#x2F;github.com&#x2F;mabezdev" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://mabez.dev/blog/posts">Blog</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>Oct 17, 2022</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  5 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>Rust on Espressif chips - 17-10-2022</h1>
	</header>

	<div class="content">
        
	  <p>This is the next quarterly update of esp-rs effort, detailing the progress over Q3 2022.</p>
<h2 id="rust-compiler-llvm">Rust Compiler &amp; LLVM</h2>
<p>The Rust compiler fork and LLVM have seen a few changes and fixes over the last quarter. Firstly, we have a new way to install the Xtensa-enabled toolchain, introducing <a href="https://github.com/esp-rs/espup">espup</a>. espup is a new Rust-based installer that replaces the unwieldy bash scripts we were previously using; we're still maintaining those for the time being but the future will be espup.</p>
<p>A few issues have been spotted in the last quarter, the first related to the alignment of 128bit arguments on the Xtensa arch which caused <a href="https://github.com/esp-rs/rust/issues/137">#137</a> &amp; <a href="https://github.com/esp-rs/rust/issues/135">#135</a>. The second was a loop miscompilation issue in the code generated by the LLVM backend which caused <a href="https://github.com/esp-rs/rust/issues/134">#134</a> &amp; <a href="https://github.com/esp-rs/rust/issues/127">#127</a>. This has now been fixed in LLVM and will be released with Rust 1.65.0. Finally, there are some code generation issues around printing floats which can be seen in <a href="https://github.com/esp-rs/rust/issues/136">#136</a>, this is an ongoing issue that I haven't gotten to the bottom of.</p>
<p>Lastly, we have some progress to report on the LLVM Xtensa upstreaming - it's moving! Eight of the ten initial patches have been approved thanks to some new reviewing effort upstream. Since then Cadence (the IP holder for Xtensa) has publically released <a href="https://www.cadence.com/content/dam/cadence-www/global/en_US/documents/tools/ip/tensilica-ip/isa-summary.pdf">an ISA summary</a> which is fantastic news for the open source community in general but especially us as there is now an official document that reviewers can use to review our backend. We started <a href="https://discourse.llvm.org/t/rfc-request-for-upstream-tensilica-xtensa-esp32-backend/65355/3">a new RFC</a> to finally get the initial patches merged upstream.</p>
<h2 id="esp-hal-bare-metal">esp-hal &amp; bare metal</h2>
<p>esp-hal development has been coming along nicely! We even released our first and second releases during this quarter, which is quite the milestone as we now believe that the HAL is in a good enough spot for it to be experimented with.</p>
<ul>
<li>Very basic support for running applications on the other core <a href="https://github.com/esp-rs/esp-hal/pull/96">#96</a></li>
<li>ADC support <a href="https://github.com/esp-rs/esp-hal/pull/97">#97</a> <a href="https://github.com/esp-rs/esp-hal/pull/98">#98</a></li>
<li>Allow for configuring the UART <a href="https://github.com/esp-rs/esp-hal/pull/99">#99</a> <a href="https://github.com/esp-rs/esp-hal/pull/102">#102</a></li>
<li>Vectored interrupts <a href="https://github.com/esp-rs/esp-hal/pull/103">#103</a> <a href="https://github.com/esp-rs/esp-hal/pull/118">#118</a></li>
<li>Direct-boot support for the ESP32-S3 <a href="https://github.com/esp-rs/esp-hal/pull/107">#107</a></li>
<li>CPU clock settings <a href="https://github.com/esp-rs/esp-hal/pull/110">#110</a> <a href="https://github.com/esp-rs/esp-hal/pull/111">#111</a></li>
<li>LEDC support <a href="https://github.com/esp-rs/esp-hal/pull/114">#114</a></li>
<li>Critical section implementations <a href="https://github.com/esp-rs/esp-hal/pull/151">#151</a></li>
<li><code>embedded_hal@1.0.0-alpha.x</code> traits implemented for most peripherals (multiple PRs)</li>
<li>A large number of bug fixes, smaller features, refactoring, etc. (multiple PRs)</li>
</ul>
<h2 id="esp-wifi">esp-wifi</h2>
<p>esp-wifi has had a lot of attention in the last quarter, plenty of fixes and improvements to make it more reliable, as well as adding new target support!</p>
<ul>
<li>Remove global allocator <a href="https://github.com/esp-rs/esp-wifi/pull/73">#73</a></li>
<li>Reduce project size by using size optimized WiFi blobs <a href="https://github.com/esp-rs/esp-wifi/pull/66">#66</a></li>
<li>Switch the Bluetooth stack to bleps <a href="https://github.com/esp-rs/esp-wifi/pull/65">#65</a></li>
<li>Add WiFi support for the ESP32-S2 <a href="https://github.com/esp-rs/esp-wifi/pull/62">#62</a></li>
<li>Add WiFi support for the ESP32-S3 <a href="https://github.com/esp-rs/esp-wifi/pull/55">#55</a></li>
<li>Remove bespoke code in favour of relying on esp-hal where possible (multiple PRs)</li>
<li>Fix order of magnitude timestamp creation error <a href="https://github.com/esp-rs/esp-wifi/pull/44">#44</a></li>
</ul>
<h2 id="esp-storage">esp-storage</h2>
<p><a href="https://github.com/esp-rs/esp-storage">esp-storage</a> is a new crate that implements the <a href="https://docs.rs/embedded-storage/latest/embedded_storage/">embedded-storage</a> traits for Espressif chips. This is useful for writing data to internal flash, which could be paired up with flash aware filesystem.</p>
<h2 id="tooling">Tooling</h2>
<h3 id="espflash">espflash</h3>
<p>Espflash has seen some great improvements over the last quarter. We're building up to a 2.0 release soon which will feature a much improved, and importantly, consistent CLI.</p>
<ul>
<li>Support for ESP32-C2 added <a href="https://github.com/esp-rs/espflash/pull/204">#204</a></li>
<li>Support for using stub loaders added <a href="https://github.com/esp-rs/espflash/pull/216">#216</a></li>
<li>Improved support for ESP-IDF partition tables (multiple PRs)</li>
<li>Support for flashing the ESP32-S2 via CDC UART <a href="https://github.com/esp-rs/espflash/pull/228">#228</a></li>
<li>Support for erasing OTA data <a href="https://github.com/esp-rs/espflash/pull/229">#229</a></li>
<li>Support flashing via the built-in UART peripherals on Raspberry Pi <a href="https://github.com/esp-rs/espflash/pull/234">#234</a></li>
<li>Relicensed under MIT/Apache-2.0 <a href="https://github.com/esp-rs/espflash/pull/235">#235</a></li>
<li>CLI interface redesign <a href="https://github.com/esp-rs/espflash/pull/239">#239</a></li>
<li>A large number of bug fixes, smaller features, refactoring, etc. (multiple PRs)</li>
</ul>
<h3 id="rust-flasher-stub">Rust flasher stub</h3>
<p>Flashing stubs are small programs that the flashing tool uploads to the chip to improve the features or speed of flashing. The stubs available for Espressif chips are currently written in C and can be found <a href="https://github.com/espressif/esptool/tree/master/flasher_stub">here</a>. These stubs have grown organically over the years and we've wanted to rewrite them for a while. We took this opportunity to write them in Rust! You can find the project <a href="https://github.com/esp-rs/esp-flasher-stub">here</a>, which currently only has a stub for the esp32c3, but esp32 support is being worked on. </p>
<h3 id="wokwi">Wokwi</h3>
<p>Wokwi now has in-browser support for building Rust applications for Espressif chips. Check out <a href="https://wokwi.com/rust">wokwi.com/rust</a> and play around with some examples in the comfort of your browser!</p>
<p><a href="https://github.com/MabezDev/wokwi-server">wokwi-server</a>, the cargo runner for running applications in Wokwi has been updated to <code>v0.2.0</code>. This includes bumping Tokio to the latest stable and providing prebuilt binaries on the releases page.</p>
<h2 id="espressif-devcon-2022">Espressif DevCon 2022 <!-- Link to my talk & Juraj's & Uri's --></h2>
<p>Espressif is excited to be hosting our first-ever conference this year! It's a two-day event starting on the 19th of October! I will be talking about Rust at Espressif along with some of my colleagues. Be sure to register <a href="https://devcon.espressif.com/">here</a> then drop in and say hi!</p>
<ul>
<li>19th October 13:05 CEST - Rust on Espressif Chips - Scott Mabin</li>
<li>19th October 14:30 CEST - Your browser is ESP32 - Uri Shaked</li>
<li>20th October 16:45 CEST - Paradigm Shift to Cloud-Based Embedded Development - Juraj Michálek, Sergio Gasquez</li>
</ul>
<h2 id="what-s-next">What's next?</h2>
<p>Continue to improve the Rust Xtensa fork, and push for LLVM upstreaming, maybe we'll see Xtensa (as an experimental target) in upstream Rust sooner than we thought! On a side note, we've started an &quot;awesome&quot; list of awesome esp rust things - check it out <a href="https://github.com/esp-rs/awesome-esp-rust">here</a>.</p>
<br/>
<hr />
<br/>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
	  <p>
		<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
		
		
		<span class="tag"><a href="https://mabez.dev/tags/rust/">rust</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/espressif/">espressif</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/esp32/">esp32</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/llvm/">llvm</a></span>
		
		
    </p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1195 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-10-17</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2025 <a href="https:&#x2F;&#x2F;mabez.dev">Scott Mabin</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
	&#183; <a href="https://mabez.dev/rss.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	
  </p>
</footer>




	</div>
	
	<script src="https://mabez.dev/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    

	
	<script src="https://mabez.dev/js/copy.js"></script>
	
	<script src="https://mabez.dev/js/main.js"></script>

    
    

	
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146726046-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'UA-146726046-1');
    </script>
    
  </body>
</html>
