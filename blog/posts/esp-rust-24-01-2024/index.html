<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Scott Mabin" />
  <meta itemprop="description" content="Scott Mabin&#x27;s blog" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://mabez.dev/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://mabez.dev/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://mabez.dev/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://mabez.dev/favicon.ico"
  />
  <link rel="stylesheet" href="https://mabez.dev/style.css"/>
  
  <title>Rust on Espressif chips - 24-01-2024</title>
  

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://mabez.dev/rss.xml">
  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;mabez.dev">Scott Mabin</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://mabez.dev/blog/posts">Blog</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;scott-mabin" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="https:&#x2F;&#x2F;github.com&#x2F;mabezdev" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://mabez.dev/blog/posts">Blog</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>Jan 24, 2024</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  3 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>Rust on Espressif chips - 24-01-2024</h1>
	</header>

	<div class="content">
        
	  <p>This is the next quarterly update of the esp-rs effort, detailing the progress over Q4 2023.</p>
<h2 id="rust-compiler">Rust Compiler</h2>
<h3 id="upstream">Upstream</h3>
<p>Over Q4 we saw many improvements to the upstream RISC-V targets. Firstly, all bare metal non-atomic (not <code>a</code>) targets now <a href="https://github.com/rust-lang/rust/pull/114499">have atomic load/store code generation</a> enabled! This was a massive pain point for users of the ESP32C3 and ESP32C2, along with other RISC-V targets in the wild. It's currently still in nightly, but with the 1.76, release it will be available on stable. Secondly, we added the <code>riscv32imafc-unknown-none-elf</code> target, ready for the <a href="https://www.espressif.com/en/news/ESP32-P4">ESP32P4</a>, Espressif's first chip without a radio. We also promoted all the current bare metal RISC-V targets to tier 2, and in doing so, filled out the missing <a href="https://github.com/rust-lang/rust/pull/117874">platform support document</a>. Finally, we added an <code>espidf</code> target for the ESP32P4, <a href="https://github.com/rust-lang/rust/pull/119738">riscv32imafc-esp-espidf</a>.</p>
<h3 id="xtensa">Xtensa</h3>
<p>The LLVM team at Espressif has continued to improve and rebase the Xtensa LLVM backend, which has recently been rebased on LLVM 17. Unfortunately, we don't have any upstream progress to report at this time.</p>
<h2 id="esp-hal-no-std">esp-hal - no_std</h2>
<p>Q4 saw the <code>v0.13</code>, <code>v0.14</code> and <code>v0.15</code> release of esp-hal. Highlights include new async drivers for PARL_IO, I2S and RMT; along with updating to the long-awaited <code>v1.0</code> of embedded-hal! We expanded on our low-power support by unifying the API across all chips, as well as adding ULP (Ultra-Low-Powered) core support for the ESP32S2 &amp; ESP32S3. Lastly, one cool feature we implemented was <code>flip-link</code> for the ESP32C6 and ESP32H2, <code>flip-link</code> gives zero-cost stack overflow detection, which is really nice for chips like these that don't have an MMU that can catch this in hardware. Check out the full <a href="https://github.com/esp-rs/esp-hal/blob/main/CHANGELOG.md">changelog</a> for all the details and changes.</p>
<p>One important breaking change that should be noted is that we no longer support atomic emulation, as upstream Rust now supports atomic load &amp; stores on non-atomic targets. Users with applications using the ESP32S2, ESP32C3 or ESP32C2, please read <a href="https://github.com/esp-rs/esp-hal/blob/main/CHANGELOG.md#breaking-1">this</a> to ease upgrading. For CAS-based atomics, you should switch to the <a href="https://github.com/taiki-e/portable-atomic">portable-atomic</a> crate. A huge thank you to <a href="https://github.com/taiki-e">@taiki-e</a> for adding support for our targets in portable-atomic, and supporting crates, as well as pushing the atomic load/store compiler changes through!</p>
<h2 id="esp-wifi-no-std">esp-wifi - no_std</h2>
<p>In Q4 we added support for BLE with the ESP32H2, fixed coexistence support on the ESP32 and added a benchmark example to test WiFi throughput. On top of that, we finally released <code>esp-wifi</code> on crates.io! We spent a long time refining and documenting to get to this point and we're pleased to have it published. </p>
<h2 id="tooling">Tooling</h2>
<h3 id="espflash">espflash</h3>
<p>Q4 saw the release of <code>v2.1.0</code> of espflash, a small release with some new functionality for erasing sectors, regions and partitions. We then began the <code>v3.0</code> development cycle, which will include <a href="https://github.com/esp-rs/esp-flasher-stub">the Rust-based flashing stubs</a> by default! Check out the unreleased section of the <a href="https://github.com/esp-rs/espflash/blob/main/CHANGELOG.md#added">changelog</a> to see what's been added so far.</p>
<h3 id="probe-rs">probe-rs</h3>
<p>There has been a tonne of progress with probe-rs and Espressif chips over Q4. This is all driven by the fact we want to start testing using real hardware in CI, known as Hardware In Loop (HIL) testing.</p>
<p>Newer Espressif chips are all RISC-V based, which probe-rs already has good support for. The ESP32, ESP32S2 and ESP32S3, however, are Xtensa-based, there for to test these in CI, we need <a href="https://github.com/probe-rs/probe-rs/issues/2001">Xtensa architecture support in probe-rs</a> and that's what we set out to do. I am happy to report that we have enough Xtensa support in probe-rs to, connect, inspect and flash the ESP32S2 and ESP32S3! This also comes with some huge speed improvements to <em>all</em> chips thanks to improvements in the USB-SERIAL-JTAG and FTDI drivers in probe-rs. All of this would not be possible without the help of the probe-rs team and of course the hard work of one particular individual, <a href="https://github.com/bugadani">DÃ¡niel Buga</a> who has been championing this work.</p>
<h2 id="rfc">RFC</h2>
<h3 id="esp-openthread">esp-openthread</h3>
<p>We're looking for input on what to develop next with esp-openthread, if you are looking to use thread in your project or product, please take a look at <a href="https://github.com/esp-rs/esp-openthread/issues/4">this RFC issue</a>.</p>
<h2 id="future-work">Future work</h2>
<p>To see what we'll be working on this quarter, check out Jesse Braham's <a href="https://beta7.io/posts/esp-rs-quarterly-planning-q1-2024/">post</a>!</p>
<br/>
<hr />
<br/>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
	  <p>
		<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>
		
		
		<span class="tag"><a href="https://mabez.dev/tags/rust/">rust</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/espressif/">espressif</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/esp32/">esp32</a></span>
		
		<span class="tag"><a href="https://mabez.dev/tags/llvm/">llvm</a></span>
		
		
    </p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>818 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2024-01-24</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2024 <a href="https:&#x2F;&#x2F;mabez.dev">Scott Mabin</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
	&#183; <a href="https://mabez.dev/rss.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
	
  </p>
</footer>




	</div>
	
	<script src="https://mabez.dev/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    

	
	<script src="https://mabez.dev/js/copy.js"></script>
	
	<script src="https://mabez.dev/js/main.js"></script>

    
    

	
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146726046-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'UA-146726046-1');
    </script>
    
  </body>
</html>
